AWSTemplateFormatVersion: "2010-09-09"

Description: "Infrastructure for the academic friends project"

Parameters:
  UserName:
    Type: String
    MinLength: 6
    MaxLength: 20
    Description: New account username
  UserPassword:
    NoEcho: "true"
    Type: String
    Description: New account password
    MinLength: 8
    MaxLength: 20

Resources:
  AdminGroup:
    Type: AWS::IAM::Group
  AdminPolicies:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: AdminPolicy
      PolicyDocument:
        Statement:
        - Effect: Allow
          Action: [ "*" ]
          Resource: "*"
      Groups: [ !Ref "AdminGroup" ]
  User:
    Type: AWS::IAM::User
    Properties:
      UserName: !Ref UserName
      LoginProfile:
        Password: !Ref UserPassword
      Groups: [ !Ref AdminGroup ]
  Keys:
    Type: AWS::IAM::AccessKey
    Properties:
      UserName: !Ref "User"
  UserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: academic-friends-cognito
      UsernameAttributes:
      - email
      AdminCreateUserConfig:
        AllowAdminCreateUserOnly: true
      AutoVerifiedAttributes: [ ]
      Policies:
        PasswordPolicy:
          MinimumLength: 8
      Schema:
      - Name: role
        Required: false
        Mutable: true
        AttributeDataType: String
      AccountRecoverySetting:
        RecoveryMechanisms:
        - Name: verified_email
          Priority: 1
  UserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName: academic-friends-app-client
      UserPoolId: !Ref UserPool
      ExplicitAuthFlows:
      - ALLOW_REFRESH_TOKEN_AUTH
      - ALLOW_USER_PASSWORD_AUTH
  MyBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: academic-friends-bucket

Outputs:
  AccessKey:
    Value: !Ref "Keys"
    Description: AWSAccessKeyId of new user
  SecretKey:
    Value: !GetAtt [ Keys, SecretAccessKey ]
    Description: AWSSecretAccessKey of new user
  UserPoolId:
    Value: !Ref "UserPool"
    Description: UserPoolId of new user
  UserPoolClientId:
    Value: !Ref "UserPoolClient"
    Description: UserPoolClientId of new user